<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0a0f">
<title>IdeaForge</title>
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
    --bg-primary: #0a0a0f;
    --bg-secondary: #111116;
    --bg-tertiary: #1a1a22;
    --bg-elevated: #222230;
    --accent: #00d4aa;
    --accent-dim: rgba(0,212,170,0.12);
    --accent-glow: rgba(0,212,170,0.4);
    --secondary: #7c3aed;
    --secondary-dim: rgba(124,58,237,0.12);
    --danger: #ef4444;
    --danger-dim: rgba(239,68,68,0.12);
    --text-primary: #ffffff;
    --text-secondary: #a0a0b0;
    --text-muted: #606070;
    --border: rgba(255,255,255,0.08);
    --safe-top: env(safe-area-inset-top,0px);
    --safe-bottom: env(safe-area-inset-bottom,0px);
    --nav-height: 72px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{font-family:'Inter',-apple-system,sans-serif;background:var(--bg-primary);color:var(--text-primary);line-height:1.5;-webkit-font-smoothing:antialiased}

/* Screens */
.screen{position:fixed;inset:0;background:var(--bg-primary);opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s;z-index:1;overflow-y:auto;-webkit-overflow-scrolling:touch}
.screen.active{opacity:1;visibility:visible;z-index:10}
.screen-content{padding:24px;padding-top:calc(24px + var(--safe-top));padding-bottom:calc(140px + var(--safe-bottom));min-height:100%}

/* Onboarding */
#onboarding{z-index:100;display:flex;flex-direction:column;justify-content:center;padding:24px;padding-top:calc(24px + var(--safe-top));padding-bottom:calc(24px + var(--safe-bottom))}
#onboarding::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 30% 20%,rgba(0,212,170,.08),transparent 50%),radial-gradient(ellipse at 70% 80%,rgba(124,58,237,.08),transparent 50%);pointer-events:none}
.brand{text-align:center;margin-bottom:40px;position:relative;z-index:1}
.brand-logo{width:88px;height:88px;margin:0 auto 20px;background:linear-gradient(135deg,var(--accent-dim),var(--secondary-dim));border-radius:24px;display:flex;align-items:center;justify-content:center;font-size:44px;box-shadow:0 16px 48px rgba(0,212,170,.2);animation:float 4s ease-in-out infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
.brand-name{font-size:32px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.brand-tagline{font-size:15px;color:var(--text-secondary);margin-top:8px}
.step-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:24px;padding:28px 20px;position:relative;z-index:1}
.step-progress{display:flex;gap:8px;margin-bottom:28px}
.step-dot{flex:1;height:4px;background:var(--bg-tertiary);border-radius:2px;transition:background .3s}
.step-dot.done{background:var(--accent)}
.step-dot.current{background:linear-gradient(90deg,var(--accent) 50%,var(--bg-tertiary) 50%)}
.step{display:none;animation:fadeIn .3s}
.step.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.step-title{font-size:20px;font-weight:600;margin-bottom:6px}
.step-desc{font-size:14px;color:var(--text-secondary);margin-bottom:24px;line-height:1.5}
.options-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
.option{padding:18px 12px;background:var(--bg-tertiary);border:2px solid transparent;border-radius:14px;text-align:center;cursor:pointer;transition:all .2s}
.option:active{transform:scale(.97)}
.option.selected{border-color:var(--accent);background:var(--accent-dim)}
.option-icon{font-size:28px;margin-bottom:8px}
.option-label{font-size:13px;font-weight:500}
.input-field{width:100%;padding:16px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:12px;color:var(--text-primary);font-family:inherit;font-size:16px;transition:border-color .2s,box-shadow .2s}
.input-field:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim)}
.input-field::placeholder{color:var(--text-muted)}
textarea.input-field{resize:none;min-height:100px;line-height:1.5}
.input-hint{font-size:13px;color:var(--text-muted);margin-top:12px}
.input-hint a{color:var(--accent);text-decoration:none}
.btn-row{display:flex;gap:12px;margin-top:20px}
.btn{flex:1;padding:16px 20px;border:none;border-radius:12px;font-family:inherit;font-size:15px;font-weight:600;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:8px}
.btn:active{transform:scale(.97)}
.btn-primary{background:linear-gradient(135deg,var(--accent),#00b894);color:#000;box-shadow:0 8px 24px var(--accent-glow)}
.btn-primary:disabled{opacity:.5;cursor:not-allowed;box-shadow:none}
.btn-secondary{background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border)}
.btn-ghost{background:transparent;color:var(--text-secondary)}
.btn-full{width:100%}

/* Main */
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
.header h1{font-size:28px;font-weight:700}
.icon-btn{width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;font-size:18px;cursor:pointer;transition:all .2s}
.icon-btn:active{transform:scale(.95);background:var(--bg-tertiary)}
.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px}
.stat{background:var(--bg-secondary);border:1px solid var(--border);border-radius:14px;padding:16px;text-align:center}
.stat-val{font-size:26px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.stat-label{font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-top:4px}
.filters{display:flex;gap:10px;overflow-x:auto;padding-bottom:4px;margin-bottom:20px;scrollbar-width:none}
.filters::-webkit-scrollbar{display:none}
.filter{flex-shrink:0;padding:10px 18px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:100px;font-size:13px;font-weight:500;color:var(--text-secondary);cursor:pointer;transition:all .2s}
.filter:active{transform:scale(.96)}
.filter.active{background:var(--accent);border-color:var(--accent);color:#000}
.ideas{display:flex;flex-direction:column;gap:14px}
.idea{background:var(--bg-secondary);border:1px solid var(--border);border-radius:16px;padding:18px;position:relative;cursor:pointer;transition:all .2s}
.idea:active{transform:scale(.985);background:var(--bg-tertiary)}
.idea-accent{position:absolute;top:18px;bottom:18px;left:0;width:3px;border-radius:0 3px 3px 0}
.idea-header{display:flex;justify-content:space-between;margin-bottom:10px;padding-left:14px}
.idea-badge{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;padding:5px 12px;border-radius:100px}
.idea-date{font-size:12px;color:var(--text-muted)}
.idea-title{font-size:16px;font-weight:600;margin-bottom:6px;padding-left:14px;line-height:1.4}
.idea-preview{font-size:14px;color:var(--text-secondary);padding-left:14px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;line-height:1.5}
.idea-footer{display:flex;gap:16px;margin-top:12px;padding-top:12px;padding-left:14px;border-top:1px solid var(--border);font-size:12px;color:var(--text-muted)}
.empty{text-align:center;padding:60px 20px}
.empty-icon{font-size:56px;margin-bottom:16px;opacity:.5}
.empty h3{font-size:18px;margin-bottom:8px}
.empty p{font-size:14px;color:var(--text-secondary);line-height:1.5}

/* FAB */
.fab-wrap{position:fixed;bottom:calc(var(--nav-height) + 20px + var(--safe-bottom));left:50%;transform:translateX(-50%);z-index:50}
.fab{width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#00b894);border:none;font-size:26px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 28px var(--accent-glow);transition:all .2s}
.fab:active{transform:scale(.92)}
.fab.recording{background:linear-gradient(135deg,var(--danger),#dc2626);box-shadow:0 8px 28px rgba(239,68,68,.5);animation:pulse 1s infinite}
@keyframes pulse{50%{transform:scale(1.08)}}
.rec-indicator{position:fixed;bottom:calc(var(--nav-height) + 96px + var(--safe-bottom));left:50%;transform:translateX(-50%);background:var(--bg-secondary);border:1px solid var(--danger);padding:10px 24px;border-radius:100px;display:none;align-items:center;gap:12px;z-index:50}
.rec-indicator.visible{display:flex}
.rec-dot{width:10px;height:10px;background:var(--danger);border-radius:50%;animation:blink 1s infinite}
@keyframes blink{50%{opacity:.3}}
.rec-time{font-size:16px;font-weight:600;color:var(--danger);font-variant-numeric:tabular-nums}

/* Nav */
.nav{position:fixed;bottom:0;left:0;right:0;height:calc(var(--nav-height) + var(--safe-bottom));background:rgba(10,10,15,.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;justify-content:space-around;padding-top:10px;z-index:40}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 20px;background:none;border:none;color:var(--text-muted);font-family:inherit;font-size:11px;font-weight:500;cursor:pointer}
.nav-item.active{color:var(--accent)}
.nav-icon{font-size:22px}

/* Capture */
.capture-header{text-align:center;margin-bottom:28px}
.capture-header h1{font-size:24px;margin-bottom:6px}
.capture-header p{color:var(--text-secondary);font-size:14px}
.capture-area{background:var(--bg-secondary);border:2px dashed var(--border);border-radius:20px;padding:28px 20px;min-height:180px;display:flex;flex-direction:column;transition:all .25s;margin-bottom:20px}
.capture-area.has-content{border-style:solid;border-color:var(--accent)}
.capture-area.recording{border-color:var(--danger);background:var(--danger-dim)}
.capture-placeholder{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;color:var(--text-muted)}
.capture-placeholder .icon{font-size:48px;margin-bottom:12px;opacity:.5}
.capture-placeholder p{font-size:14px;line-height:1.5}
.capture-textarea{flex:1;background:transparent;border:none;color:var(--text-primary);font-family:inherit;font-size:16px;line-height:1.6;resize:none;min-height:140px}
.capture-textarea:focus{outline:none}
.voice-btn{width:100%;padding:16px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:14px;color:var(--text-primary);font-family:inherit;font-size:15px;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:all .2s;margin-bottom:24px}
.voice-btn:active{transform:scale(.98)}
.voice-btn.recording{background:var(--danger-dim);border-color:var(--danger);color:var(--danger)}
.form-section{margin-bottom:24px}
.form-label{font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px}
.cat-grid{display:flex;flex-wrap:wrap;gap:10px}
.cat-chip{padding:12px 18px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:100px;font-size:14px;color:var(--text-secondary);cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:8px}
.cat-chip:active{transform:scale(.95)}
.cat-chip.selected{background:var(--accent);border-color:var(--accent);color:#000;font-weight:500}
.cat-chip.add{border-style:dashed;color:var(--text-muted)}

/* Detail */
.back-btn{display:flex;align-items:center;gap:8px;background:none;border:none;color:var(--text-secondary);font-family:inherit;font-size:15px;cursor:pointer;padding:8px 0;margin-bottom:20px}
.detail-badge{display:inline-block;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;padding:6px 14px;border-radius:100px;margin-bottom:14px}
.detail-title{font-size:26px;font-weight:700;line-height:1.3;margin-bottom:10px}
.detail-meta{font-size:13px;color:var(--text-muted)}
.detail-content{font-size:16px;line-height:1.75;color:var(--text-secondary);margin:24px 0;padding:20px;background:var(--bg-secondary);border-radius:16px;border:1px solid var(--border)}
.action-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:32px}
.action-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:14px;padding:18px;text-align:center;cursor:pointer;transition:all .2s}
.action-card:active{transform:scale(.97);background:var(--bg-tertiary)}
.action-card .icon{font-size:26px;margin-bottom:8px}
.action-card .label{font-size:13px;color:var(--text-secondary)}
.section-title{font-size:18px;font-weight:600;margin-bottom:6px}
.section-desc{font-size:14px;color:var(--text-muted);margin-bottom:16px}
.mentor-scroll{display:flex;gap:12px;overflow-x:auto;padding-bottom:8px;margin-bottom:16px;scrollbar-width:none}
.mentor-scroll::-webkit-scrollbar{display:none}
.mentor-card{flex-shrink:0;width:115px;background:var(--bg-secondary);border:2px solid var(--border);border-radius:14px;padding:16px 12px;text-align:center;cursor:pointer;transition:all .2s}
.mentor-card:active{transform:scale(.96)}
.mentor-card.selected{border-color:var(--secondary);background:var(--secondary-dim)}
.mentor-avatar{font-size:36px;margin-bottom:10px}
.mentor-name{font-size:13px;font-weight:600;margin-bottom:4px}
.mentor-role{font-size:10px;color:var(--text-muted);line-height:1.3}
.mentor-panel{background:var(--bg-secondary);border:1px solid var(--border);border-radius:16px;padding:20px;display:none;margin-top:16px}
.mentor-panel.visible{display:block;animation:fadeIn .3s}
.mentor-selected{display:flex;align-items:center;gap:14px;margin-bottom:16px}
.mentor-selected .avatar{font-size:32px}
.mentor-selected .name{font-size:16px;font-weight:600}
.mentor-selected .role{font-size:12px;color:var(--text-muted)}
.mentor-feedback{background:var(--bg-tertiary);border-radius:12px;padding:18px;margin-top:16px;display:none}
.mentor-feedback.visible{display:block;animation:fadeIn .3s}
.mentor-feedback-text{font-size:15px;line-height:1.7;color:var(--text-secondary);white-space:pre-wrap}

/* Connections */
.conn-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:14px}
.conn-theme{font-size:15px;font-weight:600;color:var(--secondary);margin-bottom:14px;display:flex;align-items:center;gap:8px}
.conn-ideas{display:flex;flex-direction:column;gap:10px}
.conn-item{background:var(--bg-tertiary);border-radius:10px;padding:14px;font-size:14px;cursor:pointer;transition:all .2s}
.conn-item:active{background:var(--bg-elevated)}
.conn-insight{margin-top:16px;padding-top:16px;border-top:1px solid var(--border);font-size:14px;color:var(--text-secondary);line-height:1.6}

/* Settings */
.settings-section{margin-bottom:28px}
.settings-section-title{font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px;padding-left:4px}
.settings-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:16px;overflow:hidden}
.settings-item{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;cursor:pointer;transition:background .2s;border-bottom:1px solid var(--border)}
.settings-item:last-child{border-bottom:none}
.settings-item:active{background:var(--bg-tertiary)}
.settings-item-left{display:flex;align-items:center;gap:14px}
.settings-item-icon{font-size:18px;width:24px;text-align:center}
.settings-item-label{font-size:15px}
.settings-item-value{font-size:14px;color:var(--text-muted)}
.settings-item.danger .settings-item-label{color:var(--danger)}
.api-display{font-size:13px;color:var(--text-muted);background:var(--bg-tertiary);padding:6px 12px;border-radius:6px;font-family:monospace}

/* Modals */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:flex-end;justify-content:center;z-index:200;padding:20px;padding-bottom:0}
.modal-overlay.visible{display:flex}
.modal{background:var(--bg-secondary);border-radius:24px 24px 0 0;padding:24px;padding-bottom:calc(24px + var(--safe-bottom));width:100%;max-width:500px;max-height:80vh;overflow-y:auto;animation:slideUp .3s}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 20px}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.modal-title{font-size:18px;font-weight:600}
.modal-close{width:32px;height:32px;display:flex;align-items:center;justify-content:center;background:var(--bg-tertiary);border:none;border-radius:50%;color:var(--text-secondary);font-size:18px;cursor:pointer}
.modal-content{font-size:15px;line-height:1.7;color:var(--text-secondary);white-space:pre-wrap}

/* Loading & Toast */
.loading{display:flex;flex-direction:column;align-items:center;gap:14px;padding:40px}
.spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.toast{position:fixed;bottom:calc(var(--nav-height) + 100px + var(--safe-bottom));left:50%;transform:translateX(-50%) translateY(20px);background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-primary);padding:14px 24px;border-radius:100px;font-size:14px;font-weight:500;z-index:300;opacity:0;pointer-events:none;transition:all .3s;box-shadow:0 8px 32px rgba(0,0,0,.5)}
.toast.visible{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.success{border-color:var(--accent)}
.toast.error{border-color:var(--danger)}
.hidden{display:none!important}
</style>
</head>
<body>
<!-- ONBOARDING -->
<div id="onboarding" class="screen active">
    <div class="brand">
        <div class="brand-logo">üí°</div>
        <h1 class="brand-name">IdeaForge</h1>
        <p class="brand-tagline" id="tagline">Capture, refine, and connect your ideas</p>
    </div>
    <div class="step-card">
        <div class="step-progress">
            <div class="step-dot done" data-step="1"></div>
            <div class="step-dot" data-step="2"></div>
            <div class="step-dot" data-step="3"></div>
            <div class="step-dot" data-step="4"></div>
        </div>
        <div class="step active" data-step="1">
            <h2 class="step-title">Choose your language</h2>
            <p class="step-desc">Select your preferred language for the app</p>
            <div class="options-grid" id="langOptions">
                <div class="option selected" data-lang="en"><div class="option-icon">üá∫üá∏</div><div class="option-label">English</div></div>
                <div class="option" data-lang="es"><div class="option-icon">üá™üá∏</div><div class="option-label">Espa√±ol</div></div>
            </div>
            <button class="btn btn-primary btn-full" id="step1Next">Continue</button>
        </div>
        <div class="step" data-step="2">
            <h2 class="step-title" id="step2Title">What do you do?</h2>
            <p class="step-desc" id="step2Desc">This helps our AI mentors give you relevant feedback</p>
            <div class="options-grid" id="profOptions">
                <div class="option" data-prof="entrepreneur"><div class="option-icon">üöÄ</div><div class="option-label">Entrepreneur</div></div>
                <div class="option" data-prof="creative"><div class="option-icon">üé®</div><div class="option-label">Creative</div></div>
                <div class="option" data-prof="developer"><div class="option-icon">üíª</div><div class="option-label">Developer</div></div>
                <div class="option" data-prof="consultant"><div class="option-icon">üìä</div><div class="option-label">Consultant</div></div>
                <div class="option" data-prof="academic"><div class="option-icon">üìö</div><div class="option-label">Academic</div></div>
                <div class="option" data-prof="marketing"><div class="option-icon">üì¢</div><div class="option-label">Marketing</div></div>
            </div>
            <input type="text" class="input-field" id="customProf" placeholder="Or type your profession...">
            <div class="btn-row">
                <button class="btn btn-secondary" id="step2Back">Back</button>
                <button class="btn btn-primary" id="step2Next">Continue</button>
            </div>
        </div>
        <div class="step" data-step="3">
            <h2 class="step-title" id="step3Title">Tell me more about you</h2>
            <p class="step-desc" id="step3Desc">What industry? What excites you?</p>
            <textarea class="input-field" id="userContext" placeholder="e.g., UX designer at a fintech startup..."></textarea>
            <div class="btn-row">
                <button class="btn btn-secondary" id="step3Back">Back</button>
                <button class="btn btn-primary" id="step3Next">Continue</button>
            </div>
        </div>
        <div class="step" data-step="4">
            <h2 class="step-title" id="step4Title">OpenAI API Key</h2>
            <p class="step-desc" id="step4Desc">Required for voice & AI. Stored only on this device.</p>
            <input type="password" class="input-field" id="apiKeyInput" placeholder="sk-...">
            <p class="input-hint">Get your key at <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a></p>
            <div class="btn-row">
                <button class="btn btn-secondary" id="step4Back">Back</button>
                <button class="btn btn-primary" id="step4Done">Start Creating</button>
            </div>
        </div>
    </div>
</div>

<!-- MAIN -->
<div id="main" class="screen">
    <div class="screen-content">
        <div class="header">
            <h1 id="mainTitle">Ideas</h1>
            <button class="icon-btn" id="searchBtn">üîç</button>
        </div>
        <div class="stats">
            <div class="stat"><div class="stat-val" id="statIdeas">0</div><div class="stat-label">Ideas</div></div>
            <div class="stat"><div class="stat-val" id="statCats">0</div><div class="stat-label">Categories</div></div>
            <div class="stat"><div class="stat-val" id="statFb">0</div><div class="stat-label">Feedback</div></div>
        </div>
        <div class="filters" id="filters"></div>
        <div class="ideas" id="ideasList"></div>
    </div>
</div>

<!-- CAPTURE -->
<div id="capture" class="screen">
    <div class="screen-content">
        <button class="back-btn" id="captureBack">‚Üê Cancel</button>
        <div class="capture-header">
            <h1 id="captureTitle">New Idea</h1>
            <p id="captureDesc">Speak or type your idea</p>
        </div>
        <div class="capture-area" id="captureArea">
            <div class="capture-placeholder" id="capturePh">
                <div class="icon">üé§</div>
                <p>Tap the microphone to record<br>or start typing below</p>
            </div>
            <textarea class="capture-textarea hidden" id="captureTa" placeholder="Type your idea here..."></textarea>
        </div>
        <button class="voice-btn" id="voiceBtn">
            <span>üé§</span>
            <span id="voiceBtnLabel">Record Idea</span>
        </button>
        <div class="form-section">
            <div class="form-label">Category</div>
            <div class="cat-grid" id="catGrid"></div>
        </div>
        <div class="form-section">
            <div class="form-label">Title (optional)</div>
            <input type="text" class="input-field" id="ideaTitle" placeholder="AI will generate if empty">
        </div>
        <button class="btn btn-primary btn-full" id="saveIdeaBtn" disabled>Save Idea</button>
    </div>
</div>

<!-- DETAIL -->
<div id="detail" class="screen">
    <div class="screen-content">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
            <button class="back-btn" id="detailBack" style="margin:0">‚Üê Back</button>
            <div style="display:flex;gap:8px">
                <button class="icon-btn" id="editIdeaBtn">‚úèÔ∏è</button>
                <button class="icon-btn" id="deleteIdeaBtn">üóëÔ∏è</button>
            </div>
        </div>
        <div class="detail-badge" id="detailBadge"></div>
        <h1 class="detail-title" id="detailTitle"></h1>
        <p class="detail-meta" id="detailMeta"></p>
        <div class="detail-content" id="detailContent"></div>
        <div class="action-grid">
            <div class="action-card" id="insightsBtn"><div class="icon">üí°</div><div class="label">Insights</div></div>
            <div class="action-card" id="roadmapBtn"><div class="icon">üó∫Ô∏è</div><div class="label">Roadmap</div></div>
        </div>
        <h3 class="section-title">üß† Ask a Mentor</h3>
        <p class="section-desc">Select a mentor for their unique perspective</p>
        <div class="mentor-scroll" id="mentorScroll"></div>
        <div class="mentor-panel" id="mentorPanel">
            <div class="mentor-selected">
                <div class="avatar" id="selMentorAvatar"></div>
                <div><div class="name" id="selMentorName"></div><div class="role" id="selMentorRole"></div></div>
            </div>
            <button class="btn btn-primary btn-full" id="askMentorBtn">Get Feedback</button>
            <div class="mentor-feedback" id="mentorFeedback">
                <div class="mentor-feedback-text" id="mentorFbText"></div>
            </div>
        </div>
    </div>
</div>

<!-- CONNECTIONS -->
<div id="connections" class="screen">
    <div class="screen-content">
        <div class="header"><h1>Connections</h1></div>
        <p style="text-align:center;color:var(--text-secondary);margin-bottom:24px">Discover patterns between your ideas</p>
        <div id="connList"></div>
        <button class="btn btn-primary btn-full" id="findConnBtn" style="margin-top:20px">üîç Find Connections</button>
    </div>
</div>

<!-- SETTINGS -->
<div id="settings" class="screen">
    <div class="screen-content">
        <div class="header">
            <h1>Settings</h1>
            <button class="btn btn-ghost" id="settingsDone">Done</button>
        </div>
        <div class="settings-section">
            <div class="settings-section-title">Profile</div>
            <div class="settings-card">
                <div class="settings-item" id="editProfBtn"><div class="settings-item-left"><span class="settings-item-icon">üë§</span><span class="settings-item-label">Profession</span></div><span class="settings-item-value" id="setProfVal">-</span></div>
                <div class="settings-item" id="toggleLangBtn"><div class="settings-item-left"><span class="settings-item-icon">üåê</span><span class="settings-item-label">Language</span></div><span class="settings-item-value" id="setLangVal">English</span></div>
            </div>
        </div>
        <div class="settings-section">
            <div class="settings-section-title">API</div>
            <div class="settings-card">
                <div class="settings-item" id="editApiBtn"><div class="settings-item-left"><span class="settings-item-icon">üîë</span><span class="settings-item-label">API Key</span></div><span class="api-display" id="setApiVal">‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span></div>
            </div>
        </div>
        <div class="settings-section">
            <div class="settings-section-title">Data</div>
            <div class="settings-card">
                <div class="settings-item" id="exportBtn"><div class="settings-item-left"><span class="settings-item-icon">üì§</span><span class="settings-item-label">Export Backup</span></div></div>
                <div class="settings-item" id="importBtn"><div class="settings-item-left"><span class="settings-item-icon">üì•</span><span class="settings-item-label">Import Backup</span></div></div>
                <div class="settings-item danger" id="clearBtn"><div class="settings-item-left"><span class="settings-item-icon">üóëÔ∏è</span><span class="settings-item-label">Delete All Data</span></div></div>
            </div>
        </div>
    </div>
</div>

<!-- FAB -->
<div class="fab-wrap" id="fabWrap"><button class="fab" id="fab">üé§</button></div>

<!-- Recording Indicator -->
<div class="rec-indicator" id="recIndicator"><div class="rec-dot"></div><div class="rec-time" id="recTime">00:00</div></div>

<!-- Nav -->
<div class="nav" id="nav">
    <button class="nav-item active" data-screen="main"><span class="nav-icon">üí°</span><span>Ideas</span></button>
    <button class="nav-item" data-screen="connections"><span class="nav-icon">üîó</span><span>Connections</span></button>
    <button class="nav-item" data-screen="settings"><span class="nav-icon">‚öôÔ∏è</span><span>Settings</span></button>
</div>

<!-- Modals -->
<div class="modal-overlay" id="insightsModal">
    <div class="modal">
        <div class="modal-handle"></div>
        <div class="modal-header"><h3 class="modal-title">üí° Insights</h3><button class="modal-close" data-close="insightsModal">√ó</button></div>
        <div class="modal-content" id="insightsContent"></div>
    </div>
</div>
<div class="modal-overlay" id="roadmapModal">
    <div class="modal">
        <div class="modal-handle"></div>
        <div class="modal-header"><h3 class="modal-title">üó∫Ô∏è Roadmap</h3><button class="modal-close" data-close="roadmapModal">√ó</button></div>
        <div class="modal-content" id="roadmapContent"></div>
    </div>
</div>
<div class="modal-overlay" id="catModal">
    <div class="modal">
        <div class="modal-handle"></div>
        <div class="modal-header"><h3 class="modal-title">New Category</h3><button class="modal-close" data-close="catModal">√ó</button></div>
        <div class="form-section"><div class="form-label">Name</div><input type="text" class="input-field" id="newCatName" placeholder="e.g., Hobbies"></div>
        <div class="form-section"><div class="form-label">Emoji</div><input type="text" class="input-field" id="newCatEmoji" placeholder="üéÆ" maxlength="2"></div>
        <button class="btn btn-primary btn-full" id="createCatBtn">Create Category</button>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Hidden input -->
<input type="file" id="importInput" accept=".json" style="display:none">

<script>
(function() {
    'use strict';
    
    // ========== i18n ==========
    const i18n = {
        en: {
            tagline:'Capture, refine, and connect your ideas',
            continue:'Continue',back:'Back',cancel:'Cancel',done:'Done',start:'Start Creating',
            step2Title:'What do you do?',step2Desc:'This helps our AI mentors give you relevant feedback',step2Custom:'Or type your profession...',
            step3Title:'Tell me more about you',step3Desc:'What industry? What excites you?',step3Ph:'e.g., UX designer at a fintech startup...',
            step4Title:'OpenAI API Key',step4Desc:'Required for voice & AI. Stored only on this device.',
            ideas:'Ideas',categories:'Categories',feedback:'Feedback',all:'All',
            emptyTitle:'Your first idea awaits',emptyDesc:'Tap the microphone to capture your first idea',
            newIdea:'New Idea',newIdeaDesc:'Speak or type your idea',record:'Record Idea',recording:'Tap to Stop',
            category:'Category',titleOpt:'Title (optional)',titlePh:'AI will generate if empty',saveIdea:'Save Idea',
            insights:'Insights',roadmap:'Roadmap',askMentor:'Ask a Mentor',getMentorFb:'Get Feedback',
            connections:'Connections',findConn:'üîç Find Connections',connEmpty:'No connections yet',connEmptyDesc:'Need at least 3 ideas',
            settings:'Settings',profile:'Profile',profession:'Profession',language:'Language',api:'API',apiKey:'API Key',
            data:'Data',exportBackup:'Export Backup',importBackup:'Import Backup',deleteAll:'Delete All Data',
            toastSaved:'Idea saved!',toastDeleted:'Idea deleted',toastWelcome:'Welcome to IdeaForge!',
            toastRecording:'Recording...',toastTranscribed:'Transcription complete!',toastError:'Something went wrong',
            toastApiReq:'Please enter a valid API key',toastProfReq:'Please select or enter profession',toastNeedMore:'Need at least 3 ideas',
            catBusiness:'Business',catProduct:'Product',catContent:'Content',catPersonal:'Personal',catTech:'Tech',catAdd:'+ New',
            mentorStrategist:'Strategist',mentorStrategistRole:'Market viability',
            mentorCritic:'Critic',mentorCriticRole:'Finds the flaws',
            mentorCreative:'Creative',mentorCreativeRole:'Expands ideas',
            mentorPragmatic:'Pragmatic',mentorPragmaticRole:'Execution focus',
            mentorInvestor:'Investor',mentorInvestorRole:'ROI & numbers',
            mentorUser:'User',mentorUserRole:'Customer view'
        },
        es: {
            tagline:'Captura, refina y conecta tus ideas',
            continue:'Continuar',back:'Atr√°s',cancel:'Cancelar',done:'Listo',start:'Comenzar',
            step2Title:'¬øA qu√© te dedicas?',step2Desc:'Esto ayuda a nuestros mentores IA a darte feedback relevante',step2Custom:'O escribe tu profesi√≥n...',
            step3Title:'Cu√©ntame m√°s sobre ti',step3Desc:'¬øQu√© industria? ¬øQu√© te emociona?',step3Ph:'Ej: Dise√±ador UX en startup fintech...',
            step4Title:'API Key de OpenAI',step4Desc:'Necesaria para voz e IA. Solo en este dispositivo.',
            ideas:'Ideas',categories:'Categor√≠as',feedback:'Feedback',all:'Todas',
            emptyTitle:'Tu primera idea te espera',emptyDesc:'Toca el micr√≥fono para capturar tu idea',
            newIdea:'Nueva Idea',newIdeaDesc:'Habla o escribe tu idea',record:'Grabar Idea',recording:'Toca para Detener',
            category:'Categor√≠a',titleOpt:'T√≠tulo (opcional)',titlePh:'La IA generar√° uno',saveIdea:'Guardar Idea',
            insights:'Insights',roadmap:'Roadmap',askMentor:'Consulta un Mentor',getMentorFb:'Pedir Feedback',
            connections:'Conexiones',findConn:'üîç Buscar Conexiones',connEmpty:'Sin conexiones',connEmptyDesc:'Necesitas 3+ ideas',
            settings:'Ajustes',profile:'Perfil',profession:'Profesi√≥n',language:'Idioma',api:'API',apiKey:'API Key',
            data:'Datos',exportBackup:'Exportar',importBackup:'Importar',deleteAll:'Borrar Todo',
            toastSaved:'¬°Idea guardada!',toastDeleted:'Idea eliminada',toastWelcome:'¬°Bienvenido a IdeaForge!',
            toastRecording:'Grabando...',toastTranscribed:'¬°Transcripci√≥n lista!',toastError:'Algo sali√≥ mal',
            toastApiReq:'Ingresa una API key v√°lida',toastProfReq:'Selecciona o escribe profesi√≥n',toastNeedMore:'Necesitas 3+ ideas',
            catBusiness:'Negocio',catProduct:'Producto',catContent:'Contenido',catPersonal:'Personal',catTech:'Tech',catAdd:'+ Nueva',
            mentorStrategist:'Estratega',mentorStrategistRole:'Viabilidad',
            mentorCritic:'Cr√≠tico',mentorCriticRole:'Encuentra fallas',
            mentorCreative:'Creativo',mentorCreativeRole:'Expande ideas',
            mentorPragmatic:'Pragm√°tico',mentorPragmaticRole:'Ejecuci√≥n',
            mentorInvestor:'Inversor',mentorInvestorRole:'ROI y n√∫meros',
            mentorUser:'Usuario',mentorUserRole:'Vista cliente'
        }
    };
    
    const t = k => (i18n[state.user?.lang||'en']||i18n.en)[k]||k;
    
    // ========== STATE ==========
    let state = {
        user: null,
        ideas: [],
        categories: [
            {id:'business',emoji:'üíº',color:'#00d4aa'},
            {id:'product',emoji:'üì¶',color:'#7c3aed'},
            {id:'content',emoji:'‚úçÔ∏è',color:'#f59e0b'},
            {id:'personal',emoji:'üå±',color:'#ec4899'},
            {id:'tech',emoji:'üîß',color:'#3b82f6'}
        ],
        connections: [],
        currentIdea: null,
        selectedMentor: null,
        selectedCat: null,
        isRecording: false,
        mediaRecorder: null,
        audioChunks: [],
        recordingStart: null,
        recordingTimer: null,
        currentStep: 1
    };
    
    const MENTORS = {
        strategist:{avatar:'üéØ',name:'mentorStrategist',role:'mentorStrategistRole'},
        critic:{avatar:'üî•',name:'mentorCritic',role:'mentorCriticRole'},
        creative:{avatar:'‚ú®',name:'mentorCreative',role:'mentorCreativeRole'},
        pragmatic:{avatar:'üî®',name:'mentorPragmatic',role:'mentorPragmaticRole'},
        investor:{avatar:'üí∞',name:'mentorInvestor',role:'mentorInvestorRole'},
        user:{avatar:'üë§',name:'mentorUser',role:'mentorUserRole'}
    };
    
    const MENTOR_PROMPTS = {
        strategist:'Business strategist. Analyze market, competition, barriers, model. Be direct.',
        critic:'Brutal but constructive critic. Find ALL flaws. End with ONE fix.',
        creative:'Visionary creative. EXPAND: 10x bigger? Combinations?',
        pragmatic:'COO. Convert to ACTION: first step, resources, MVP time.',
        investor:'Investor. Evaluate cost, return, scalability.',
        user:'Typical user. Would you pay? Daily use? Frustrations?'
    };
    
    // ========== PERSISTENCE ==========
    const load = () => {
        try {
            const d = localStorage.getItem('ideaforge-v2');
            if (d) state = {...state, ...JSON.parse(d)};
        } catch(e) { console.error('Load error:', e); }
    };
    
    const save = () => {
        try {
            localStorage.setItem('ideaforge-v2', JSON.stringify({
                user: state.user,
                ideas: state.ideas,
                categories: state.categories,
                connections: state.connections
            }));
        } catch(e) { console.error('Save error:', e); }
    };
    
    // ========== HAPTIC ==========
    const haptic = (p=10) => { if('vibrate' in navigator) navigator.vibrate(p); };
    
    // ========== NAVIGATION ==========
    const $ = id => document.getElementById(id);
    const $$ = sel => document.querySelectorAll(sel);
    
    const navigateTo = screen => {
        haptic();
        $$('.screen').forEach(s => s.classList.remove('active'));
        $(screen).classList.add('active');
        $$('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.screen === screen));
        
        const showNav = !['onboarding','capture','detail'].includes(screen);
        $('nav').style.display = showNav ? '' : 'none';
        $('fabWrap').style.display = ['main','connections'].includes(screen) ? '' : 'none';
        
        if (screen === 'capture') resetCapture();
        if (screen === 'settings') updateSettings();
        if (screen === 'connections') renderConnections();
        if (screen === 'main') { renderIdeas(); updateStats(); }
    };
    
    // ========== ONBOARDING ==========
    const updateStep = () => {
        $$('.step').forEach(s => s.classList.toggle('active', +s.dataset.step === state.currentStep));
        $$('.step-dot').forEach(d => {
            const n = +d.dataset.step;
            d.classList.remove('done','current');
            if (n < state.currentStep) d.classList.add('done');
            else if (n === state.currentStep) d.classList.add('current');
        });
    };
    
    const nextStep = () => {
        haptic();
        if (state.currentStep === 2) {
            const sel = document.querySelector('#profOptions .option.selected');
            const custom = $('customProf').value.trim();
            if (!sel && !custom) { toast(t('toastProfReq'),'error'); return; }
            state.user = state.user || {};
            state.user.profession = custom || sel.dataset.prof;
        }
        if (state.currentStep === 3) {
            state.user.context = $('userContext').value.trim();
        }
        if (state.currentStep < 4) {
            state.currentStep++;
            updateStep();
        }
    };
    
    const prevStep = () => {
        haptic();
        if (state.currentStep > 1) {
            state.currentStep--;
            updateStep();
        }
    };
    
    const completeOnboarding = () => {
        haptic([50,30,50]);
        const key = $('apiKeyInput').value.trim();
        if (!key || !key.startsWith('sk-')) {
            toast(t('toastApiReq'),'error');
            return;
        }
        state.user.apiKey = key;
        save();
        navigateTo('main');
        toast(t('toastWelcome'),'success');
    };
    
    // ========== IDEAS ==========
    const renderIdeas = (filter='all') => {
        const list = $('ideasList');
        const filtered = filter === 'all' ? state.ideas : state.ideas.filter(i => i.category === filter);
        
        if (!filtered.length) {
            list.innerHTML = `<div class="empty"><div class="empty-icon">üí≠</div><h3>${t('emptyTitle')}</h3><p>${t('emptyDesc')}</p></div>`;
        } else {
            list.innerHTML = filtered.map(idea => {
                const cat = state.categories.find(c => c.id === idea.category) || state.categories[0];
                const date = new Date(idea.createdAt).toLocaleDateString(state.user?.lang||'en',{month:'short',day:'numeric'});
                const fb = idea.feedback?.length || 0;
                return `<div class="idea" data-id="${idea.id}">
                    <div class="idea-accent" style="background:${cat.color}"></div>
                    <div class="idea-header">
                        <span class="idea-badge" style="color:${cat.color};background:${cat.color}20">${cat.emoji} ${t('cat'+cat.id.charAt(0).toUpperCase()+cat.id.slice(1))}</span>
                        <span class="idea-date">${date}</span>
                    </div>
                    <h3 class="idea-title">${idea.title}</h3>
                    <p class="idea-preview">${idea.content}</p>
                    ${fb ? `<div class="idea-footer"><span>üß† ${fb}</span></div>` : ''}
                </div>`;
            }).join('');
        }
        renderFilters();
    };
    
    const renderFilters = () => {
        const used = [...new Set(state.ideas.map(i => i.category))];
        let html = `<div class="filter active" data-filter="all">${t('all')}</div>`;
        used.forEach(id => {
            const cat = state.categories.find(c => c.id === id);
            if (cat) html += `<div class="filter" data-filter="${id}">${cat.emoji} ${t('cat'+id.charAt(0).toUpperCase()+id.slice(1))}</div>`;
        });
        $('filters').innerHTML = html;
    };
    
    const updateStats = () => {
        $('statIdeas').textContent = state.ideas.length;
        $('statCats').textContent = [...new Set(state.ideas.map(i => i.category))].length;
        $('statFb').textContent = state.ideas.reduce((s,i) => s + (i.feedback?.length||0), 0);
    };
    
    const viewIdea = id => {
        haptic();
        const idea = state.ideas.find(i => i.id === id);
        if (!idea) return;
        state.currentIdea = idea;
        state.selectedMentor = null;
        
        const cat = state.categories.find(c => c.id === idea.category) || state.categories[0];
        const date = new Date(idea.createdAt).toLocaleDateString(state.user?.lang||'en',{year:'numeric',month:'long',day:'numeric'});
        
        $('detailBadge').textContent = `${cat.emoji} ${t('cat'+cat.id.charAt(0).toUpperCase()+cat.id.slice(1))}`;
        $('detailBadge').style.cssText = `color:${cat.color};background:${cat.color}20`;
        $('detailTitle').textContent = idea.title;
        $('detailMeta').textContent = date;
        $('detailContent').textContent = idea.content;
        
        $$('.mentor-card').forEach(c => c.classList.remove('selected'));
        $('mentorPanel').classList.remove('visible');
        $('mentorFeedback').classList.remove('visible');
        
        navigateTo('detail');
    };
    
    // ========== CAPTURE ==========
    const resetCapture = () => {
        $('capturePh').classList.remove('hidden');
        $('captureTa').classList.add('hidden');
        $('captureTa').value = '';
        $('captureArea').classList.remove('has-content','recording');
        $('ideaTitle').value = '';
        $('saveIdeaBtn').disabled = true;
        $$('.cat-chip').forEach(c => c.classList.remove('selected'));
        state.selectedCat = null;
        if (state.isRecording) stopRecording();
    };
    
    const renderCategories = () => {
        const grid = $('catGrid');
        let html = state.categories.map(cat => 
            `<div class="cat-chip" data-cat="${cat.id}">${cat.emoji} ${t('cat'+cat.id.charAt(0).toUpperCase()+cat.id.slice(1))}</div>`
        ).join('');
        html += `<div class="cat-chip add" id="addCatBtn">${t('catAdd')}</div>`;
        grid.innerHTML = html;
    };
    
    const saveIdea = async () => {
        haptic([50,30,50]);
        const content = $('captureTa').value.trim();
        let title = $('ideaTitle').value.trim();
        const category = state.selectedCat || 'business';
        if (!content) return;
        
        const btn = $('saveIdeaBtn');
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner" style="width:20px;height:20px;border-width:2px"></div>';
        
        if (!title) title = await generateTitle(content);
        
        const idea = {
            id: Date.now().toString(),
            title, content, category,
            createdAt: new Date().toISOString(),
            feedback: []
        };
        
        state.ideas.unshift(idea);
        save();
        btn.textContent = t('saveIdea');
        toast(t('toastSaved'),'success');
        navigateTo('main');
    };
    
    const generateTitle = async content => {
        try {
            const lang = state.user?.lang || 'en';
            const res = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {'Content-Type':'application/json','Authorization':`Bearer ${state.user.apiKey}`},
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [{role:'user',content:`Generate a short title (max 6 words) for this idea. ${lang==='es'?'In Spanish.':'In English.'} Only the title:\n\n${content}`}],
                    max_tokens: 30
                })
            });
            const data = await res.json();
            return data.choices[0].message.content.trim();
        } catch(e) {
            return content.substring(0,40) + '...';
        }
    };
    
    // ========== VOICE RECORDING ==========
    const toggleRecording = async () => {
        if (state.isRecording) {
            stopRecording();
        } else {
            await startRecording();
        }
    };
    
    const startRecording = async () => {
        try {
            console.log('Requesting microphone...');
            const stream = await navigator.mediaDevices.getUserMedia({audio:true});
            console.log('Microphone access granted');
            
            state.mediaRecorder = new MediaRecorder(stream);
            state.audioChunks = [];
            
            state.mediaRecorder.ondataavailable = e => {
                console.log('Audio chunk:', e.data.size);
                state.audioChunks.push(e.data);
            };
            
            state.mediaRecorder.onstop = async () => {
                console.log('Recording stopped, processing...');
                const blob = new Blob(state.audioChunks, {type:'audio/webm'});
                await transcribeAudio(blob);
                stream.getTracks().forEach(track => track.stop());
            };
            
            state.mediaRecorder.start();
            state.isRecording = true;
            state.recordingStart = Date.now();
            
            $('voiceBtn').classList.add('recording');
            $('voiceBtnLabel').textContent = t('recording');
            $('captureArea').classList.add('recording');
            $('recIndicator').classList.add('visible');
            $('fab').classList.add('recording');
            
            state.recordingTimer = setInterval(updateRecordingTime, 1000);
            haptic([50,30,50]);
            toast(t('toastRecording'),'success');
            
        } catch(e) {
            console.error('Microphone error:', e);
            toast(t('toastError') + ': ' + e.message, 'error');
        }
    };
    
    const stopRecording = () => {
        if (state.mediaRecorder && state.isRecording) {
            console.log('Stopping recording...');
            state.mediaRecorder.stop();
            state.isRecording = false;
            
            $('voiceBtn').classList.remove('recording');
            $('voiceBtnLabel').textContent = t('record');
            $('captureArea').classList.remove('recording');
            $('recIndicator').classList.remove('visible');
            $('fab').classList.remove('recording');
            
            clearInterval(state.recordingTimer);
            haptic([30,20,30]);
        }
    };
    
    const updateRecordingTime = () => {
        const elapsed = Math.floor((Date.now() - state.recordingStart) / 1000);
        const m = String(Math.floor(elapsed/60)).padStart(2,'0');
        const s = String(elapsed%60).padStart(2,'0');
        $('recTime').textContent = `${m}:${s}`;
    };
    
    const transcribeAudio = async blob => {
        toast('Transcribing...','success');
        const formData = new FormData();
        formData.append('file', blob, 'recording.webm');
        formData.append('model', 'whisper-1');
        formData.append('language', state.user?.lang || 'en');
        
        try {
            const res = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                method: 'POST',
                headers: {'Authorization': `Bearer ${state.user.apiKey}`},
                body: formData
            });
            
            if (!res.ok) throw new Error('Transcription failed: ' + res.status);
            const data = await res.json();
            console.log('Transcription:', data);
            
            $('capturePh').classList.add('hidden');
            $('captureTa').classList.remove('hidden');
            $('captureTa').value = data.text;
            $('captureArea').classList.add('has-content');
            $('saveIdeaBtn').disabled = false;
            
            haptic([50,30,50]);
            toast(t('toastTranscribed'),'success');
            
        } catch(e) {
            console.error('Transcription error:', e);
            toast(t('toastError'),'error');
        }
    };
    
    // ========== MENTORS ==========
    const renderMentors = () => {
        $('mentorScroll').innerHTML = Object.entries(MENTORS).map(([id,m]) =>
            `<div class="mentor-card" data-mentor="${id}">
                <div class="mentor-avatar">${m.avatar}</div>
                <div class="mentor-name">${t(m.name)}</div>
                <div class="mentor-role">${t(m.role)}</div>
            </div>`
        ).join('');
    };
    
    const selectMentor = id => {
        haptic();
        state.selectedMentor = id;
        const m = MENTORS[id];
        $$('.mentor-card').forEach(c => c.classList.toggle('selected', c.dataset.mentor === id));
        $('selMentorAvatar').textContent = m.avatar;
        $('selMentorName').textContent = t(m.name);
        $('selMentorRole').textContent = t(m.role);
        $('mentorPanel').classList.add('visible');
        $('mentorFeedback').classList.remove('visible');
    };
    
    const askMentor = async () => {
        if (!state.selectedMentor || !state.currentIdea) return;
        haptic();
        
        const btn = $('askMentorBtn');
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner" style="width:20px;height:20px;border-width:2px"></div>';
        
        const lang = state.user?.lang || 'en';
        
        try {
            const res = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {'Content-Type':'application/json','Authorization':`Bearer ${state.user.apiKey}`},
                body: JSON.stringify({
                    model: 'gpt-4o',
                    messages: [
                        {role:'system',content:`${MENTOR_PROMPTS[state.selectedMentor]} Respond in ${lang==='es'?'Spanish':'English'}. Context: ${state.user.profession}. ${state.user.context||''}`},
                        {role:'user',content:`Idea: "${state.currentIdea.title}"\n\n${state.currentIdea.content}`}
                    ],
                    max_tokens: 500
                })
            });
            
            const data = await res.json();
            const feedback = data.choices[0].message.content;
            
            state.currentIdea.feedback = state.currentIdea.feedback || [];
            state.currentIdea.feedback.push({mentor:state.selectedMentor,feedback,date:new Date().toISOString()});
            save();
            updateStats();
            
            $('mentorFbText').textContent = feedback;
            $('mentorFeedback').classList.add('visible');
            haptic([50,30,50]);
            
        } catch(e) {
            console.error('Mentor error:', e);
            toast(t('toastError'),'error');
        }
        
        btn.disabled = false;
        btn.textContent = t('getMentorFb');
    };
    
    // ========== INSIGHTS & ROADMAP ==========
    const showInsights = async () => {
        haptic();
        $('insightsModal').classList.add('visible');
        $('insightsContent').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        
        const lang = state.user?.lang || 'en';
        try {
            const res = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {'Content-Type':'application/json','Authorization':`Bearer ${state.user.apiKey}`},
                body: JSON.stringify({
                    model: 'gpt-4o',
                    messages: [
                        {role:'system',content:`Generate insights: üíé Unique value, üéØ Audience, ‚ö†Ô∏è Risk, üöÄ Opportunity, üí° Question. ${lang==='es'?'In Spanish.':'In English.'}`},
                        {role:'user',content:`Context: ${state.user.profession}. ${state.user.context||''}\n\nIdea: "${state.currentIdea.title}"\n${state.currentIdea.content}`}
                    ],
                    max_tokens: 600
                })
            });
            const data = await res.json();
            $('insightsContent').textContent = data.choices[0].message.content;
        } catch(e) {
            $('insightsContent').textContent = t('toastError');
        }
    };
    
    const showRoadmap = async () => {
        haptic();
        $('roadmapModal').classList.add('visible');
        $('roadmapContent').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        
        const lang = state.user?.lang || 'en';
        try {
            const res = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {'Content-Type':'application/json','Authorization':`Bearer ${state.user.apiKey}`},
                body: JSON.stringify({
                    model: 'gpt-4o',
                    messages: [
                        {role:'system',content:`Create roadmap: üìÖ Week 1, üìÖ Weeks 2-4, üìÖ Months 2-3, üí∞ Cost, ‚è±Ô∏è MVP time. ${lang==='es'?'In Spanish.':'In English.'}`},
                        {role:'user',content:`Context: ${state.user.profession}. ${state.user.context||''}\n\nIdea: "${state.currentIdea.title}"\n${state.currentIdea.content}`}
                    ],
                    max_tokens: 800
                })
            });
            const data = await res.json();
            $('roadmapContent').textContent = data.choices[0].message.content;
        } catch(e) {
            $('roadmapContent').textContent = t('toastError');
        }
    };
    
    // ========== CONNECTIONS ==========
    const findConnections = async () => {
        if (state.ideas.length < 3) {
            toast(t('toastNeedMore'),'error');
            return;
        }
        haptic();
        
        const btn = $('findConnBtn');
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner" style="width:20px;height:20px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:8px"></div> Analyzing...';
        
        const lang = state.user?.lang || 'en';
        const summary = state.ideas.map(i => `- ${i.title}: ${i.content.substring(0,80)}`).join('\n');
        
        try {
            const res = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {'Content-Type':'application/json','Authorization':`Bearer ${state.user.apiKey}`},
                body: JSON.stringify({
                    model: 'gpt-4o',
                    messages: [
                        {role:'system',content:`Find 2-3 groups of connected ideas. JSON only: {"connections":[{"theme":"...","ideas":["t1","t2"],"insight":"..."}]}. ${lang==='es'?'Spanish.':'English.'}`},
                        {role:'user',content:`Ideas:\n${summary}`}
                    ],
                    max_tokens: 800
                })
            });
            
            const data = await res.json();
            const content = data.choices[0].message.content.replace(/```json\n?|\n?```/g,'');
            state.connections = JSON.parse(content).connections;
            save();
            renderConnections();
            haptic([50,30,50]);
            
        } catch(e) {
            console.error('Connections error:', e);
            toast(t('toastError'),'error');
        }
        
        btn.disabled = false;
        btn.textContent = t('findConn');
    };
    
    const renderConnections = () => {
        const list = $('connList');
        if (!state.connections?.length) {
            list.innerHTML = `<div class="empty"><div class="empty-icon">üîó</div><h3>${t('connEmpty')}</h3><p>${t('connEmptyDesc')}</p></div>`;
            return;
        }
        list.innerHTML = state.connections.map(conn =>
            `<div class="conn-card">
                <div class="conn-theme">üîó ${conn.theme}</div>
                <div class="conn-ideas">${conn.ideas.map(title => {
                    const idea = state.ideas.find(i => i.title === title);
                    return `<div class="conn-item" ${idea?`data-id="${idea.id}"`:''}>` + title + '</div>';
                }).join('')}</div>
                <div class="conn-insight">${conn.insight}</div>
            </div>`
        ).join('');
    };
    
    // ========== SETTINGS ==========
    const updateSettings = () => {
        $('setProfVal').textContent = state.user?.profession || '-';
        $('setLangVal').textContent = state.user?.lang === 'es' ? 'Espa√±ol' : 'English';
        const key = state.user?.apiKey || '';
        $('setApiVal').textContent = key ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + key.slice(-4) : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
    };
    
    const editProfile = () => {
        haptic();
        const p = prompt('Profession:', state.user?.profession || '');
        if (p !== null) {
            state.user.profession = p;
            const c = prompt('Context:', state.user?.context || '');
            if (c !== null) state.user.context = c;
            save();
            updateSettings();
        }
    };
    
    const toggleLanguage = () => {
        haptic();
        state.user.lang = state.user?.lang === 'es' ? 'en' : 'es';
        save();
        updateSettings();
        renderCategories();
        renderMentors();
        renderIdeas();
    };
    
    const editApiKey = () => {
        haptic();
        const k = prompt('New API key:');
        if (k && k.startsWith('sk-')) {
            state.user.apiKey = k;
            save();
            updateSettings();
        }
    };
    
    const exportData = () => {
        haptic();
        const d = {
            user: {...state.user, apiKey: undefined},
            ideas: state.ideas,
            categories: state.categories,
            connections: state.connections,
            exportedAt: new Date().toISOString()
        };
        const blob = new Blob([JSON.stringify(d,null,2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `ideaforge-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        toast('Exported','success');
    };
    
    const importData = () => {
        haptic();
        $('importInput').click();
    };
    
    const clearAllData = () => {
        haptic();
        if (confirm('Delete ALL data?') && confirm('Sure?')) {
            localStorage.removeItem('ideaforge-v2');
            location.reload();
        }
    };
    
    // ========== MODALS & TOAST ==========
    const closeModal = id => {
        haptic();
        $(id).classList.remove('visible');
    };
    
    const toast = (msg, type='') => {
        const t = $('toast');
        t.textContent = msg;
        t.className = 'toast visible' + (type ? ' ' + type : '');
        setTimeout(() => t.classList.remove('visible'), 3000);
    };
    
    // ========== EVENT LISTENERS ==========
    const initEvents = () => {
        // Onboarding - Language
        $('langOptions').addEventListener('click', e => {
            const opt = e.target.closest('.option');
            if (!opt) return;
            haptic();
            $$('#langOptions .option').forEach(o => o.classList.remove('selected'));
            opt.classList.add('selected');
            state.user = state.user || {};
            state.user.lang = opt.dataset.lang;
        });
        
        // Onboarding - Profession
        $('profOptions').addEventListener('click', e => {
            const opt = e.target.closest('.option');
            if (!opt) return;
            haptic();
            $$('#profOptions .option').forEach(o => o.classList.remove('selected'));
            opt.classList.add('selected');
            $('customProf').value = '';
        });
        
        $('customProf').addEventListener('input', function() {
            if (this.value.trim()) $$('#profOptions .option').forEach(o => o.classList.remove('selected'));
        });
        
        // Onboarding buttons
        $('step1Next').addEventListener('click', nextStep);
        $('step2Back').addEventListener('click', prevStep);
        $('step2Next').addEventListener('click', nextStep);
        $('step3Back').addEventListener('click', prevStep);
        $('step3Next').addEventListener('click', nextStep);
        $('step4Back').addEventListener('click', prevStep);
        $('step4Done').addEventListener('click', completeOnboarding);
        
        // Navigation
        $$('.nav-item').forEach(item => {
            item.addEventListener('click', () => navigateTo(item.dataset.screen));
        });
        
        $('fab').addEventListener('click', () => navigateTo('capture'));
        
        // Main
        $('searchBtn').addEventListener('click', () => {
            haptic();
            const q = prompt('Search:');
            if (q?.trim()) {
                const results = state.ideas.filter(i => 
                    i.title.toLowerCase().includes(q.toLowerCase()) ||
                    i.content.toLowerCase().includes(q.toLowerCase())
                );
                if (results.length === 1) viewIdea(results[0].id);
            }
        });
        
        $('ideasList').addEventListener('click', e => {
            const idea = e.target.closest('.idea');
            if (idea) viewIdea(idea.dataset.id);
        });
        
        $('filters').addEventListener('click', e => {
            const filter = e.target.closest('.filter');
            if (!filter) return;
            haptic();
            $$('.filter').forEach(f => f.classList.remove('active'));
            filter.classList.add('active');
            renderIdeas(filter.dataset.filter);
        });
        
        // Capture
        $('captureBack').addEventListener('click', () => navigateTo('main'));
        $('voiceBtn').addEventListener('click', toggleRecording);
        
        $('captureTa').addEventListener('input', function() {
            const has = this.value.trim().length > 0;
            $('saveIdeaBtn').disabled = !has;
            $('captureArea').classList.toggle('has-content', has);
        });
        
        $('catGrid').addEventListener('click', e => {
            const chip = e.target.closest('.cat-chip');
            if (!chip) return;
            if (chip.id === 'addCatBtn') {
                haptic();
                $('catModal').classList.add('visible');
                return;
            }
            haptic();
            $$('.cat-chip').forEach(c => c.classList.remove('selected'));
            chip.classList.add('selected');
            state.selectedCat = chip.dataset.cat;
        });
        
        $('saveIdeaBtn').addEventListener('click', saveIdea);
        
        // Detail
        $('detailBack').addEventListener('click', () => navigateTo('main'));
        $('editIdeaBtn').addEventListener('click', () => {
            haptic();
            if (!state.currentIdea) return;
            const c = prompt('Edit:', state.currentIdea.content);
            if (c !== null && c.trim()) {
                state.currentIdea.content = c.trim();
                const ti = prompt('Title:', state.currentIdea.title);
                if (ti !== null && ti.trim()) state.currentIdea.title = ti.trim();
                save();
                $('detailTitle').textContent = state.currentIdea.title;
                $('detailContent').textContent = state.currentIdea.content;
            }
        });
        $('deleteIdeaBtn').addEventListener('click', () => {
            haptic();
            if (!state.currentIdea) return;
            if (confirm('Delete this idea?')) {
                state.ideas = state.ideas.filter(i => i.id !== state.currentIdea.id);
                save();
                toast(t('toastDeleted'));
                navigateTo('main');
            }
        });
        $('insightsBtn').addEventListener('click', showInsights);
        $('roadmapBtn').addEventListener('click', showRoadmap);
        
        $('mentorScroll').addEventListener('click', e => {
            const card = e.target.closest('.mentor-card');
            if (card) selectMentor(card.dataset.mentor);
        });
        
        $('askMentorBtn').addEventListener('click', askMentor);
        
        // Connections
        $('findConnBtn').addEventListener('click', findConnections);
        $('connList').addEventListener('click', e => {
            const item = e.target.closest('.conn-item');
            if (item?.dataset.id) viewIdea(item.dataset.id);
        });
        
        // Settings
        $('settingsDone').addEventListener('click', () => navigateTo('main'));
        $('editProfBtn').addEventListener('click', editProfile);
        $('toggleLangBtn').addEventListener('click', toggleLanguage);
        $('editApiBtn').addEventListener('click', editApiKey);
        $('exportBtn').addEventListener('click', exportData);
        $('importBtn').addEventListener('click', importData);
        $('clearBtn').addEventListener('click', clearAllData);
        
        $('importInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = evt => {
                try {
                    const d = JSON.parse(evt.target.result);
                    if (d.ideas) {
                        state.ideas = d.ideas;
                        state.categories = d.categories || state.categories;
                        state.connections = d.connections || [];
                        save();
                        renderIdeas();
                        updateStats();
                        renderCategories();
                        toast('Imported','success');
                    }
                } catch(err) {
                    toast(t('toastError'),'error');
                }
            };
            reader.readAsText(file);
            this.value = '';
        });
        
        // Modals
        $$('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', e => {
                if (e.target === modal) closeModal(modal.id);
            });
        });
        
        $$('.modal-close').forEach(btn => {
            btn.addEventListener('click', () => closeModal(btn.dataset.close));
        });
        
        $('createCatBtn').addEventListener('click', () => {
            haptic();
            const name = $('newCatName').value.trim();
            const emoji = $('newCatEmoji').value.trim() || 'üìå';
            if (!name) return;
            const id = name.toLowerCase().replace(/\s+/g,'-');
            const colors = ['#00d4aa','#7c3aed','#f59e0b','#ec4899','#3b82f6','#10b981'];
            state.categories.push({id, emoji, color: colors[state.categories.length % colors.length]});
            save();
            renderCategories();
            closeModal('catModal');
            $('newCatName').value = '';
            $('newCatEmoji').value = '';
        });
    };
    
    // ========== INIT ==========
    const init = () => {
        load();
        initEvents();
        renderCategories();
        renderMentors();
        
        if (state.user?.apiKey) {
            navigateTo('main');
        } else {
            navigateTo('onboarding');
        }
    };
    
    // Start app when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>
</body>
</html>
